using DfuSeConvLib.Deserialization;
using DfuSeConvLib.Interfaces;
using Moq;
using NUnit.Framework;
using System.IO;

namespace DfuSeConvLib.Tests.Deserialization {
    [TestFixture]
    public class ImageElementDeserializerTests {
        [Test]
        public void CanRead() {
            var sample = new byte[] {
                0x00, 0x00, 0x00, 0x08,
                0x34, 0x00, 0x00, 0x00,
                0x44, 0x66, 0x75, 0x53, 0x65, 0x01, 0x9F, 0xD4, 0x00, 0x00, 0x02, 0x54, 0x61, 0x72, 0x67, 0x65, 0x74,
                0x01, 0x01, 0x00, 0x00, 0x00, 0x54, 0x41, 0x52, 0x47, 0x4E, 0x41, 0x4D, 0x45, 0x00, 0x72, 0x6F, 0x6A,
                0x65, 0x63, 0x74, 0x73, 0x5C, 0x44, 0x65, 0x73, 0x6B, 0x74, 0x6F, 0x70, 0x5C, 0x44, 0x66, 0x75, 0x53,
                0x65
            };

            var expectedData = new byte[] {
                0x44, 0x66, 0x75, 0x53, 0x65, 0x01, 0x9F, 0xD4, 0x00, 0x00, 0x02, 0x54, 0x61, 0x72, 0x67, 0x65, 0x74,
                0x01, 0x01, 0x00, 0x00, 0x00, 0x54, 0x41, 0x52, 0x47, 0x4E, 0x41, 0x4D, 0x45, 0x00, 0x72, 0x6F, 0x6A,
                0x65, 0x63, 0x74, 0x73, 0x5C, 0x44, 0x65, 0x73, 0x6B, 0x74, 0x6F, 0x70, 0x5C, 0x44, 0x66, 0x75, 0x53,
                0x65
            };

            var expectedAddress = 0x08000000u;
            var expectedLength = 52u;

            var imageElementMock = new Mock<IImageElement>();
            imageElementMock.SetupProperty(x => x.ElementAddress, 0u);
            imageElementMock.SetupProperty(x => x.ElementSize, 0u);
            imageElementMock.SetupProperty(x => x.Data, new byte[] { });

            var tempStream = new MemoryStream(sample, false);

            var sut = new ImageElementDeserializer(() => imageElementMock.Object);

            var imageElement = sut.Read(tempStream);

            Assert.That(imageElement.ElementAddress, Is.EqualTo(expectedAddress));
            Assert.That(imageElement.ElementSize, Is.EqualTo(expectedLength));
            Assert.That(imageElement.Data, Is.EqualTo(expectedData));
        }
    }
}
